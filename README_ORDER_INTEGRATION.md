# 주문통합관리 기능 구현 완료

## 📋 구현 내용

### 1. 데이터베이스 스키마
- **테이블명**: `integrated_orders`
- **위치**: `database/migrations/create_integrated_orders.sql`
- **주요 필드**:
  - 주문 정보: 마켓명, 주문번호, 결제일
  - 수취인 정보: 이름, 전화번호, 주소, 우편번호
  - 상품 정보: 옵션명, 수량, 셀러공급가
  - 발송 정보: 발송상태, 송장번호, 택배사, 발송일
  - CS 정보: CS상태, CS유형, CS메모
  - 기타: 메모, 태그

### 2. API 엔드포인트

#### `/api/integrated-orders` (기본 CRUD)
- **GET**: 주문 조회 (날짜, 검색어, 마켓명, 발송상태 필터링 지원)
- **POST**: 단일 주문 생성
- **PUT**: 주문 수정
- **DELETE**: 주문 삭제

#### `/api/integrated-orders/bulk` (대량 처리)
- **POST**: 대량 주문 생성 (엑셀 업로드용)
- **PUT**: 대량 주문 수정
- **DELETE**: 대량 주문 삭제

### 3. 프론트엔드 컴포넌트

#### 주문조회 탭 (SearchTab)
- 날짜별 조회 (주문통합일/결제일)
- 검색어 필터링 (주문번호, 수취인명)
- 엑셀 다운로드 기능

#### 주문입력 탭 (InputTab)
- 수동 주문 입력
- 다중 상품 추가 기능
- DB 저장 기능

#### 주문통합(Excel) 탭 (ExcelTab)
- 다중 엑셀 파일 업로드 (드래그 앤 드롭 지원)
- 자동 마켓명 감지 (파일명 기반)
- 실시간 미리보기
- DB 저장 및 엑셀 다운로드

## 🚀 설치 및 실행

### 1. 데이터베이스 마이그레이션

Supabase Dashboard (https://supabase.com/dashboard) 에 접속하여 SQL Editor에서 다음 파일을 실행하세요:

\`\`\`bash
database/migrations/create_integrated_orders.sql
\`\`\`

또는 파일 내용을 직접 복사하여 SQL Editor에서 실행하세요.

### 2. 환경 변수 확인

\`\`\`.env.local
NEXT_PUBLIC_SUPABASE_URL=your-supabase-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
\`\`\`

### 3. 개발 서버 실행

\`\`\`bash
npm run dev
\`\`\`

### 4. 접속

브라우저에서 다음 URL로 접속:
\`\`\`
http://localhost:3000/admin/order-integration
\`\`\`

## 📝 엑셀 파일 형식

엑셀 업로드 시 다음 헤더를 사용하세요 (한글 또는 영문):

| 한글 | 영문 | 필수 |
|------|------|------|
| 주문번호 | orderNumber | ✅ |
| 수취인 / 수취인명 | recipientName | ✅ |
| 옵션명 / 상품명 | optionName / productName | ✅ |
| 수량 | quantity | |
| 결제일 | paymentDate | |
| 전화번호 / 연락처 | phone | |
| 주소 | address | |
| 우편번호 | zipcode | |
| 배송메시지 | deliveryMessage | |
| 셀러공급가 | sellerSupplyPrice | |

### 예시 엑셀 데이터

| 주문번호 | 수취인 | 옵션명 | 수량 | 결제일 | 전화번호 | 주소 |
|---------|--------|--------|------|--------|----------|------|
| NS-001 | 홍길동 | 상품A-옵션1 | 2 | 2025-10-08 | 010-1234-5678 | 서울시 강남구... |
| NS-002 | 김철수 | 상품B-옵션2 | 1 | 2025-10-08 | 010-9876-5432 | 서울시 서초구... |

## 🎯 주요 기능

### 1. 자동 마켓명 감지
파일명에서 마켓명을 자동으로 감지합니다:
- "스마트스토어" 또는 "네이버" → 스마트스토어
- "쿠팡" → 쿠팡
- "11번가" → 11번가
- "토스" → 토스

### 2. 중복 방지
동일한 (마켓명 + 주문번호 + 옵션명) 조합은 자동으로 업데이트됩니다.

### 3. 필터링 및 검색
- 날짜 범위 검색 (주문통합일 또는 결제일)
- 마켓명 필터
- 발송상태 필터
- 주문번호/수취인명 검색

### 4. 대량 처리
- 한 번에 여러 엑셀 파일 업로드 가능
- 수천 건의 주문을 한 번에 처리
- upsert 방식으로 중복 자동 처리

## 🔒 보안

- Row Level Security (RLS) 활성화
- 관리자 및 매니저만 접근 가능
- 인증된 사용자만 API 호출 가능

## 📊 데이터베이스 인덱스

성능 최적화를 위한 인덱스:
- `sheet_date` (주문통합일)
- `payment_date` (결제일)
- `market_name` (마켓명)
- `order_number` (주문번호)
- `recipient_name` (수취인명)
- `shipping_status` (발송상태)
- `cs_status` (CS상태)

## 🐛 문제 해결

### 1. 데이터가 조회되지 않을 때
- Supabase Dashboard에서 RLS 정책 확인
- 현재 사용자의 role이 'admin' 또는 'manager'인지 확인

### 2. "유효한 주문 데이터가 없습니다" 오류
엑셀 업로드 시 이 오류가 발생하면:

**단계 1: 브라우저 개발자 도구 콘솔 확인**
   - F12를 누르고 Console 탭으로 이동
   - "파일 읽기", "헤더", "행" 등의 로그 확인
   - 어떤 필드가 누락되었는지 확인

**단계 2: 필수 필드 확인**
   - 주문번호, 수취인, 옵션명이 모두 있어야 함
   - 헤더 이름이 다음 중 하나와 일치해야 함:
     - **주문번호**: `주문번호`, `orderNumber`, `주문 번호`, `Order Number`
     - **수취인**: `수취인`, `수취인명`, `recipientName`, `수령인`, `이름`
     - **옵션명**: `옵션명`, `상품명`, `optionName`, `productName`, `옵션`, `상품`

**단계 3: 샘플 양식 다운로드**
   - 엑셀 탭 상단의 **"샘플 양식 다운로드"** 버튼 클릭
   - 샘플 양식을 참고하여 엑셀 파일 작성

**단계 4: 데이터 형식 확인**
   - 헤더가 첫 번째 행에 있어야 함
   - 빈 행이 없어야 함
   - 필수 필드에 빈 값이 없어야 함

### 3. 엑셀 업로드 시 일부 데이터만 처리되는 경우
- **정상 동작입니다!**
- 필수 필드가 없는 행은 자동으로 제외됩니다
- 성공 메시지에서 제외된 행 수를 확인할 수 있습니다
- 콘솔 로그에서 어떤 행이 제외되었는지 확인 가능

### 4. API 오류
- 브라우저 개발자 도구의 Network 탭에서 API 응답 확인
- 서버 콘솔에서 에러 로그 확인
- Supabase Dashboard에서 테이블 권한 확인

## 📚 추가 개발 가능 기능

1. **발송관리 탭**: 송장번호 일괄 등록, 택배사 연동
2. **CS 탭**: CS 이력 관리, 반품/교환 처리
3. **통계 대시보드**: 마켓별/일별 주문 통계
4. **알림 기능**: 미발송 주문 알림, CS 알림

## 🎉 완료 체크리스트

- [x] 데이터베이스 테이블 설계
- [x] API 엔드포인트 구현
- [x] 주문조회 탭 구현 (날짜 필터, 검색, 엑셀 다운로드)
- [x] 주문입력 탭 구현 (수동 입력, 다중 상품)
- [x] 엑셀 업로드 탭 구현 (드래그 앤 드롭, 미리보기)
- [x] 엑셀 다운로드 기능 (모든 탭에서 지원)
- [x] 엑셀 샘플 양식 다운로드 기능
- [x] DB 연동 및 저장
- [x] 유연한 필드명 매핑 (한글/영문 모두 지원)
- [x] 상세한 오류 메시지 및 디버깅 로그
- [ ] 마이그레이션 실행 (수동으로 Supabase Dashboard에서 실행 필요)
- [ ] 실제 데이터로 테스트

## 🆕 최근 업데이트

### v1.1 (현재)
- ✅ 엑셀 파싱 로직 개선: 다양한 필드명 자동 인식
- ✅ 샘플 양식 다운로드 기능 추가
- ✅ 상세한 오류 메시지 및 디버깅 정보 제공
- ✅ 콘솔 로그로 파싱 과정 추적 가능
- ✅ 유효하지 않은 데이터 상세 정보 표시

### v1.0
- ✅ 기본 주문통합관리 기능 구현
- ✅ 3개 탭 (조회, 입력, 엑셀) 완성
- ✅ DB 스키마 및 API 구현
